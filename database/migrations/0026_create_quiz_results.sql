
-- 1. Create Quiz Results Table
CREATE TABLE IF NOT EXISTS quiz_results (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    quiz_id BIGINT REFERENCES quizzes(id) ON DELETE CASCADE,
    student_id BIGINT REFERENCES students(id) ON DELETE CASCADE,
    score INTEGER NOT NULL,
    total_questions INTEGER NOT NULL,
    answers JSONB, -- Stores question_id -> answer_id mapping
    focus_violations INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. RLS Policies
ALTER TABLE quiz_results ENABLE ROW LEVEL SECURITY;

-- Allow students to insert their own results
CREATE POLICY "Students can insert their own quiz results"
    ON quiz_results FOR INSERT
    WITH CHECK (
        auth.uid() IN (
            SELECT user_id FROM students WHERE id = quiz_results.student_id
        )
    );

-- Allow students to view their own results
CREATE POLICY "Students can view their own quiz results"
    ON quiz_results FOR SELECT
    USING (
        auth.uid() IN (
            SELECT user_id FROM students WHERE id = quiz_results.student_id
        )
    );

-- Allow teachers/admins to view all results
-- (Assuming teachers have a role check or similar, simplified here to maintain existing pattern)
-- For now, relying on Supabase service role for admin, but let's add teacher policy if needed.
-- Actually, strict RLS might block teachers if not defined.
-- Let's add policy for teachers/admins based on role.

CREATE POLICY "Teachers and Admins can view all quiz results"
    ON quiz_results FOR SELECT
    USING (
        auth.uid() IN (
            SELECT id FROM users WHERE role IN ('Teacher', 'Admin', 'Proprietor')
        )
    );
