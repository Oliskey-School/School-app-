# Backend Coding Standards for School App

## ğŸ“‹ Overview

This document defines **mandatory** standards that ALL backend code must follow. Whether written by AI models or human developers, these rules ensure consistency, maintainability, and scalability.

---

## ğŸ—‚ï¸ Database Migration Organization

### Migration File Structure

```
database/
â”œâ”€â”€ migrations/                    â† All migrations go here
â”‚   â”œâ”€â”€ 0001_initial_schema.sql   â† Numbered sequentially
â”‚   â”œâ”€â”€ 0002_initial_data.sql
â”‚   â”œâ”€â”€ ...
â”‚   â”œâ”€â”€ 0019_additional_features.sql
â”‚   â”œâ”€â”€ master_migration.sql       â† Combines all migrations
â”‚   â””â”€â”€ MIGRATION_INDEX.md         â† Documents all migrations
â”œâ”€â”€ seeds/                         â† Sample/test data only
â”œâ”€â”€ triggers/                      â† Database triggers
â”œâ”€â”€ archive/                       â† Old/deprecated files
â””â”€â”€ RLS_GUIDE.md                  â† RLS policy documentation
```

### Migration Numbering System

**Format**: `XXXX_descriptive_name.sql`

- **XXXX**: 4-digit sequential number (0001-9999)
- **descriptive_name**: Lowercase with underscores
- **NO duplicates** of the same number

**Examples**:
```sql
âœ… CORRECT:
0020_user_authentication.sql
0021_payment_gateway_integration.sql
0022_notification_system.sql

âŒ WRONG:
20_user_auth.sql              (needs 4 digits)
0020-user-authentication.sql  (use underscores, not hyphens)
UserAuthentication.sql        (use lowercase)
```

### Migration File Template

```sql
-- ============================================================================
-- Migration: XXXX_descriptive_name
-- Purpose: [Brief description]
-- Created: YYYY-MM-DD
-- Dependencies: [List migrations this depends on]
-- ============================================================================

-- Section 1: Create tables
CREATE TABLE IF NOT EXISTS table_name (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Section 2: Create indexes
CREATE INDEX IF NOT EXISTS idx_table_name_column ON table_name(column_name);

-- Section 3: Enable RLS
ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;

-- Section 4: RLS Policies
CREATE POLICY "policy_name" ON table_name FOR SELECT USING (true);

-- Section 5: Comments
COMMENT ON TABLE table_name IS 'Description';

-- Completion
SELECT 'âœ… Migration XXXX completed!' as status;
```

---

## ğŸ—ï¸ Naming Conventions

### Tables
```sql
âœ… students, parent_children, teacher_subjects
âŒ Student, students_tbl, student
```

### Columns
```sql
-- Primary keys
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY

-- Foreign keys (always use _id suffix)
student_id BIGINT REFERENCES students(id)
teacher_id BIGINT REFERENCES teachers(id)

-- Timestamps (REQUIRED on all tables)
created_at TIMESTAMPTZ DEFAULT NOW()
updated_at TIMESTAMPTZ DEFAULT NOW()

-- Booleans (use is_ or has_ prefix)
is_active BOOLEAN DEFAULT true
has_permission BOOLEAN DEFAULT false

-- Text fields
full_name TEXT NOT NULL
email TEXT UNIQUE
```

### Indexes
```sql
-- Format: idx_{table}_{column(s)}
âœ… idx_students_email
âœ… idx_fees_student_id_status
âŒ students_email_idx
```

### RLS Policies
```sql
-- Format: {action}_{table}_{role/condition}
âœ… "select_students_authenticated"
âœ… "update_own_profile"
âŒ "policy1"
```

---

## ğŸ”’ Row Level Security (RLS)

### ALWAYS Enable RLS
```sql
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE teachers ENABLE ROW LEVEL SECURITY;
```

### Standard Policies
```sql
-- Public read
CREATE POLICY "select_public" ON table_name
    FOR SELECT USING (true);

-- Authenticated users
CREATE POLICY "select_authenticated" ON table_name
    FOR SELECT USING (auth.role() = 'authenticated');

-- Users own records
CREATE POLICY "update_own" ON table_name
    FOR UPDATE USING (auth.uid() = user_id);
```

---

## ğŸ“ Required Standards

### Every Table MUST Have:
- âœ… `id` (primary key)
- âœ… `created_at` timestamp
- âœ… `updated_at` timestamp
- âœ… RLS enabled
- âœ… At least one RLS policy
- âœ… Table comment

### Every Foreign Key MUST Have:
- âœ… Index
- âœ… ON DELETE action (CASCADE or SET NULL)
- âœ… Column comment

### Every Migration MUST Have:
- âœ… Sequential number (0001-9999)
- âœ… Header comment with purpose
- âœ… Completion SELECT statement
- âœ… Entry in MIGRATION_INDEX.md

---

## ğŸ¤– AI Model Instructions

When generating backend code:

1. **Read this document first**
2. **Follow ALL conventions** exactly
3. **Use templates** provided above
4. **Check existing migrations** for examples
5. **Always enable RLS**
6. **Create indexes** for all foreign keys
7. **Add comments** to tables and columns
8. **Number migrations** sequentially

**If unsure, ask rather than guess!**

---

## âœ… Pre-Deployment Checklist

- [ ] Sequential migration number
- [ ] File name format correct
- [ ] All required columns present
- [ ] Foreign keys indexed
- [ ] RLS enabled and policies defined
- [ ] Comments added
- [ ] Added to MIGRATION_INDEX.md
- [ ] Tested on dev database

---

**Last Updated**: 2026-01-05  
**Version**: 1.0
