{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\USER\\\\OneDrive\\\\Desktop\\\\Project\\\\school-app-\\\\context\\\\AuthContext.tsx\";\nimport React, { createContext, useContext, useEffect, useState } from 'react';\nimport { supabase } from '../lib/supabase';\nimport { DashboardType } from '../types';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst AuthContext = createContext(undefined);\nexport const AuthProvider = ({\n  children\n}) => {\n  const [session, setSession] = useState(null);\n  const [user, setUser] = useState(null);\n  const [role, setRole] = useState(null);\n  const [loading, setLoading] = useState(true);\n  useEffect(() => {\n    const restoreSession = () => {\n      const storedUser = sessionStorage.getItem('user');\n      const storedRole = sessionStorage.getItem('role');\n      if (storedUser && storedRole) {\n        try {\n          const parsedUser = JSON.parse(storedUser);\n          setUser(parsedUser);\n          setRole(storedRole);\n          setLoading(false);\n          return true;\n        } catch (e) {\n          console.error('Failed to parse stored session');\n        }\n      }\n      return false;\n    };\n    const sessionRestored = restoreSession();\n    const initSupabase = async () => {\n      try {\n        const {\n          data: {\n            session\n          },\n          error\n        } = await supabase.auth.getSession();\n        if (error) {\n          throw error;\n        }\n        if (!sessionRestored && session) {\n          setSession(session);\n          setUser(session.user);\n          if (session.user.user_metadata?.user_type) {\n            setRole(session.user.user_metadata.user_type);\n          }\n        }\n      } catch (error) {\n        console.error('Supabase initialization failed:', error);\n      } finally {\n        setLoading(false);\n      }\n    };\n    if (!sessionRestored) {\n      initSupabase();\n    }\n    const {\n      data: {\n        subscription\n      }\n    } = supabase.auth.onAuthStateChange(async (event, session) => {\n      const storedRole = sessionStorage.getItem('role');\n      if (storedRole) {\n        if (!session) {\n          return;\n        }\n      }\n      setSession(session);\n      if (session) {\n        setUser(session.user);\n        if (session.user.user_metadata?.user_type) {}\n      } else if (!storedRole) {\n        setUser(null);\n        setRole(null);\n      }\n      setLoading(false);\n    });\n    return () => {\n      subscription.unsubscribe();\n    };\n  }, []);\n  const getDashboardTypeFromUserType = userType => {\n    switch (userType) {\n      case 'Admin':\n        return DashboardType.Admin;\n      case 'Teacher':\n        return DashboardType.Teacher;\n      case 'Parent':\n        return DashboardType.Parent;\n      case 'Student':\n        return DashboardType.Student;\n      default:\n        return DashboardType.Student;\n    }\n  };\n  const signIn = async (dashboard, userData) => {\n    const mockUser = {\n      id: userData.userId,\n      email: userData.email,\n      user_metadata: {\n        role: userData.userType?.toLowerCase(),\n        full_name: userData.email?.split('@')[0]\n      },\n      app_metadata: {},\n      aud: 'authenticated',\n      created_at: new Date().toISOString()\n    };\n    setUser(mockUser);\n    setRole(dashboard);\n    sessionStorage.setItem('user', JSON.stringify(mockUser));\n    sessionStorage.setItem('role', dashboard);\n    console.log('✅ Auth state updated:', {\n      dashboard,\n      user: mockUser.email\n    });\n  };\n  const signOut = async () => {\n    try {\n      await supabase.auth.signOut();\n    } catch (e) {\n      console.warn('Supabase signout failed', e);\n    }\n    setRole(null);\n    setSession(null);\n    setUser(null);\n    sessionStorage.removeItem('user');\n    sessionStorage.removeItem('role');\n    sessionStorage.removeItem('userProfile');\n  };\n  return _jsxDEV(AuthContext.Provider, {\n    value: {\n      session,\n      user,\n      role,\n      loading,\n      signIn,\n      signOut\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 168,\n    columnNumber: 9\n  }, this);\n};\nexport const useAuth = () => {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n};","map":{"version":3,"names":["React","createContext","useContext","useEffect","useState","supabase","DashboardType","jsxDEV","_jsxDEV","AuthContext","undefined","AuthProvider","children","session","setSession","user","setUser","role","setRole","loading","setLoading","restoreSession","storedUser","sessionStorage","getItem","storedRole","parsedUser","JSON","parse","e","console","error","sessionRestored","initSupabase","data","auth","getSession","user_metadata","user_type","subscription","onAuthStateChange","event","unsubscribe","getDashboardTypeFromUserType","userType","Admin","Teacher","Parent","Student","signIn","dashboard","userData","mockUser","id","userId","email","toLowerCase","full_name","split","app_metadata","aud","created_at","Date","toISOString","setItem","stringify","log","signOut","warn","removeItem","Provider","value","fileName","_jsxFileName","lineNumber","columnNumber","useAuth","context","Error"],"sources":["C:/Users/USER/OneDrive/Desktop/Project/school-app-/context/AuthContext.tsx"],"sourcesContent":["import React, { createContext, useContext, useEffect, useState } from 'react';\r\nimport { supabase } from '../lib/supabase';\r\nimport { Session, User } from '@supabase/supabase-js';\r\nimport { DashboardType } from '../types';\r\n\r\ninterface AuthContextType {\r\n    session: Session | null;\r\n    user: User | null;\r\n    role: DashboardType | null;\r\n    loading: boolean;\r\n    signIn: (dashboard: DashboardType, user: any) => Promise<void>;\r\n    signOut: () => Promise<void>;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n    const [session, setSession] = useState<Session | null>(null);\r\n    const [user, setUser] = useState<User | null>(null);\r\n    const [role, setRole] = useState<DashboardType | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    useEffect(() => {\r\n        // 1. Try to restore session from sessionStorage (Tab Specific)\r\n        const restoreSession = () => {\r\n            const storedUser = sessionStorage.getItem('user');\r\n            const storedRole = sessionStorage.getItem('role');\r\n            if (storedUser && storedRole) {\r\n                try {\r\n                    const parsedUser = JSON.parse(storedUser);\r\n                    setUser(parsedUser);\r\n                    setRole(storedRole as DashboardType);\r\n                    setLoading(false);\r\n                    return true; // Successfully restored\r\n                } catch (e) {\r\n                    console.error('Failed to parse stored session');\r\n                }\r\n            }\r\n            return false;\r\n        };\r\n\r\n        const sessionRestored = restoreSession();\r\n\r\n        // 2. Initialize Supabase (only if not restored or to keep sync if needed)\r\n        const initSupabase = async () => {\r\n            try {\r\n                const { data: { session }, error } = await supabase.auth.getSession();\r\n                if (error) {\r\n                    throw error;\r\n                }\r\n\r\n                // Only override if we didn't restore a mock session \r\n                // OR if the supabase session is actually valid and different?\r\n                // For now, priority: SessionStorage (Mock) > Supabase Session\r\n                if (!sessionRestored && session) {\r\n                    setSession(session);\r\n                    setUser(session.user);\r\n                    if (session.user.user_metadata?.user_type) {\r\n                        setRole(session.user.user_metadata.user_type as DashboardType);\r\n                    }\r\n                }\r\n            } catch (error) {\r\n                console.error('Supabase initialization failed:', error);\r\n                // Fallback to offline/modals if needed, or just allow app to load in \"logged out\" state\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        if (!sessionRestored) {\r\n            initSupabase();\r\n        }\r\n\r\n        // 3. Listen for auth changes\r\n        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {\r\n            // CRITICAL FIX: IF we have a Role in this tab's sessionStorage, ignore external 'SIGNED_OUT'\r\n            // This works because local signOut() clears sessionStorage BEFORE calling supabase.signOut().\r\n            // So if we still have a role here, the signOut came from ANOTHER tab.\r\n            const storedRole = sessionStorage.getItem('role');\r\n\r\n            if (storedRole) {\r\n                // We have a local active session in this tab.\r\n                // If the event is effectively a logout (no session), ignore it to maintain isolation.\r\n                if (!session) {\r\n                    return;\r\n                }\r\n            }\r\n\r\n            setSession(session);\r\n\r\n            if (session) {\r\n                setUser(session.user);\r\n                // If metadata has role, trust it, otherwise keep storedRole\r\n                if (session.user.user_metadata?.user_type) {\r\n                    // Optionally update role if needed\r\n                }\r\n            } else if (!storedRole) {\r\n                // Only clear state if we don't have a stored role\r\n                setUser(null);\r\n                setRole(null);\r\n            }\r\n\r\n            setLoading(false);\r\n        });\r\n\r\n        return () => {\r\n            subscription.unsubscribe();\r\n        };\r\n    }, []);\r\n\r\n    const getDashboardTypeFromUserType = (userType: string): DashboardType => {\r\n        switch (userType) {\r\n            case 'Admin': return DashboardType.Admin;\r\n            case 'Teacher': return DashboardType.Teacher;\r\n            case 'Parent': return DashboardType.Parent;\r\n            case 'Student': return DashboardType.Student;\r\n            default: return DashboardType.Student;\r\n        }\r\n    };\r\n\r\n    const signIn = async (dashboard: DashboardType, userData: any) => {\r\n        // This method is called by the Login component AFTER successful Supabase auth\r\n        // or for \"Mock\" logins.\r\n\r\n        // Create a minimal user object for state\r\n        const mockUser = {\r\n            id: userData.userId,\r\n            email: userData.email,\r\n            user_metadata: {\r\n                role: userData.userType?.toLowerCase(),\r\n                full_name: userData.email?.split('@')[0],\r\n            },\r\n            app_metadata: {},\r\n            aud: 'authenticated',\r\n            created_at: new Date().toISOString(),\r\n        } as unknown as User;\r\n\r\n        // Set the user and role state\r\n        setUser(mockUser);\r\n        setRole(dashboard);\r\n\r\n        // Persist to sessionStorage for tab isolation\r\n        sessionStorage.setItem('user', JSON.stringify(mockUser));\r\n        sessionStorage.setItem('role', dashboard);\r\n\r\n        console.log('✅ Auth state updated:', { dashboard, user: mockUser.email });\r\n    };\r\n\r\n    const signOut = async () => {\r\n        try {\r\n            await supabase.auth.signOut();\r\n        } catch (e) {\r\n            console.warn('Supabase signout failed', e);\r\n        }\r\n\r\n        setRole(null);\r\n        setSession(null);\r\n        setUser(null);\r\n\r\n        // Clear session storage\r\n        sessionStorage.removeItem('user');\r\n        sessionStorage.removeItem('role');\r\n        // Clear profile storage as well if it's used elsewhere\r\n        sessionStorage.removeItem('userProfile');\r\n    };\r\n\r\n    return (\r\n        <AuthContext.Provider value={{ session, user, role, loading, signIn, signOut }}>\r\n            {children}\r\n        </AuthContext.Provider>\r\n    );\r\n};\r\n\r\nexport const useAuth = () => {\r\n    const context = useContext(AuthContext);\r\n    if (context === undefined) {\r\n        throw new Error('useAuth must be used within an AuthProvider');\r\n    }\r\n    return context;\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{"hasCjsExports":false},"sourceType":"module","externalDependencies":[]}