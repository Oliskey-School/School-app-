{"ast":null,"code":"import { useEffect, useState } from 'react';\nimport { supabase } from '../lib/supabase';\nimport { useProfile } from '../context/ProfileContext';\nexport function useRealtimeNotifications(userRole) {\n  const {\n    profile\n  } = useProfile();\n  const [notificationCount, setNotificationCount] = useState(0);\n  const [currentUserId, setCurrentUserId] = useState(profile?.id || null);\n  useEffect(() => {\n    if (profile?.id) {\n      setCurrentUserId(profile.id);\n    } else {\n      supabase.auth.getUser().then(({\n        data\n      }) => {\n        if (data.user) setCurrentUserId(data.user.id);\n      });\n    }\n  }, [profile]);\n  const fetchCount = async () => {\n    try {\n      const {\n        data,\n        error\n      } = await supabase.from('notifications').select('id, user_id, audience').eq('is_read', false);\n      if (error) {\n        console.error('Error fetching notification count:', error);\n        return;\n      }\n      const roleToCheck = userRole || profile?.role || 'student';\n      const count = data.filter(n => {\n        const isUserMatch = n.user_id && String(n.user_id) === String(currentUserId);\n        const audience = n.audience || [];\n        const isAudienceMatch = Array.isArray(audience) ? audience.map(s => s.toLowerCase()).includes(roleToCheck.toLowerCase()) : JSON.stringify(audience).toLowerCase().includes(roleToCheck.toLowerCase());\n        return isUserMatch || isAudienceMatch;\n      }).length;\n      setNotificationCount(count);\n    } catch (err) {\n      console.error(err);\n    }\n  };\n  useEffect(() => {\n    if (!currentUserId) return;\n    fetchCount();\n    const channel = supabase.channel('global_notifications').on('postgres_changes', {\n      event: '*',\n      schema: 'public',\n      table: 'notifications'\n    }, () => {\n      fetchCount();\n    }).subscribe();\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [currentUserId, userRole, profile?.role]);\n  return notificationCount;\n}","map":{"version":3,"names":["useEffect","useState","supabase","useProfile","useRealtimeNotifications","userRole","profile","notificationCount","setNotificationCount","currentUserId","setCurrentUserId","id","auth","getUser","then","data","user","fetchCount","error","from","select","eq","console","roleToCheck","role","count","filter","n","isUserMatch","user_id","String","audience","isAudienceMatch","Array","isArray","map","s","toLowerCase","includes","JSON","stringify","length","err","channel","on","event","schema","table","subscribe","removeChannel"],"sources":["C:/Users/USER/OneDrive/Desktop/Project/school-app-/hooks/useRealtimeNotifications.ts"],"sourcesContent":["import { useEffect, useState } from 'react';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useProfile } from '../context/ProfileContext';\r\n\r\nexport function useRealtimeNotifications(userRole?: string) {\r\n    const { profile } = useProfile();\r\n    const [notificationCount, setNotificationCount] = useState(0);\r\n    const [currentUserId, setCurrentUserId] = useState<string | number | null>(profile?.id || null);\r\n\r\n    // Ensure we have a User ID (Profile ID or Auth ID)\r\n    useEffect(() => {\r\n        if (profile?.id) {\r\n            setCurrentUserId(profile.id);\r\n        } else {\r\n            // Fallback for Admin or specialized roles without standard profiles\r\n            supabase.auth.getUser().then(({ data }) => {\r\n                if (data.user) setCurrentUserId(data.user.id);\r\n            });\r\n        }\r\n    }, [profile]);\r\n\r\n    const fetchCount = async () => {\r\n        try {\r\n            // 1. Fetch all unread notifications (we'll filter in memory for complex OR logic)\r\n            // Ideally, this uses an RPC or complex filter string, but client-side filtering \r\n            // is reliable for \"User ID OR Audience Array\" logic.\r\n            const { data, error } = await supabase\r\n                .from('notifications')\r\n                .select('id, user_id, audience')\r\n                .eq('is_read', false);\r\n\r\n            if (error) {\r\n                console.error('Error fetching notification count:', error);\r\n                return;\r\n            }\r\n\r\n            const roleToCheck = userRole || profile?.role || 'student'; // Default fallback\r\n\r\n            const count = data.filter(n => {\r\n                // Match 1: Specific User ID\r\n                // Handle type mismatch (DB might be int, Auth might be UUID)\r\n                const isUserMatch = n.user_id && String(n.user_id) === String(currentUserId);\r\n\r\n                // Match 2: Audience (Role)\r\n                const audience = n.audience || [];\r\n                const isAudienceMatch = Array.isArray(audience)\r\n                    ? audience.map(s => s.toLowerCase()).includes(roleToCheck.toLowerCase())\r\n                    : JSON.stringify(audience).toLowerCase().includes(roleToCheck.toLowerCase());\r\n\r\n                return isUserMatch || isAudienceMatch;\r\n            }).length;\r\n\r\n            setNotificationCount(count);\r\n        } catch (err) {\r\n            console.error(err);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (!currentUserId) return;\r\n\r\n        fetchCount();\r\n\r\n        // Subscribe to ANY change in notifications table\r\n        // We filter events locally by just refreshing the count on any event\r\n        const channel = supabase\r\n            .channel('global_notifications')\r\n            .on(\r\n                'postgres_changes',\r\n                {\r\n                    event: '*',\r\n                    schema: 'public',\r\n                    table: 'notifications',\r\n                },\r\n                () => {\r\n                    fetchCount();\r\n                }\r\n            )\r\n            .subscribe();\r\n\r\n        return () => {\r\n            supabase.removeChannel(channel);\r\n        };\r\n    }, [currentUserId, userRole, profile?.role]);\r\n\r\n    return notificationCount;\r\n}\r\n"],"mappings":"AAAA,SAASA,SAAS,EAAEC,QAAQ,QAAQ,OAAO;AAC3C,SAASC,QAAQ,QAAQ,iBAAiB;AAC1C,SAASC,UAAU,QAAQ,2BAA2B;AAEtD,OAAO,SAASC,wBAAwBA,CAACC,QAAiB,EAAE;EACxD,MAAM;IAAEC;EAAQ,CAAC,GAAGH,UAAU,CAAC,CAAC;EAChC,MAAM,CAACI,iBAAiB,EAAEC,oBAAoB,CAAC,GAAGP,QAAQ,CAAC,CAAC,CAAC;EAC7D,MAAM,CAACQ,aAAa,EAAEC,gBAAgB,CAAC,GAAGT,QAAQ,CAAyBK,OAAO,EAAEK,EAAE,IAAI,IAAI,CAAC;EAG/FX,SAAS,CAAC,MAAM;IACZ,IAAIM,OAAO,EAAEK,EAAE,EAAE;MACbD,gBAAgB,CAACJ,OAAO,CAACK,EAAE,CAAC;IAChC,CAAC,MAAM;MAEHT,QAAQ,CAACU,IAAI,CAACC,OAAO,CAAC,CAAC,CAACC,IAAI,CAAC,CAAC;QAAEC;MAAK,CAAC,KAAK;QACvC,IAAIA,IAAI,CAACC,IAAI,EAAEN,gBAAgB,CAACK,IAAI,CAACC,IAAI,CAACL,EAAE,CAAC;MACjD,CAAC,CAAC;IACN;EACJ,CAAC,EAAE,CAACL,OAAO,CAAC,CAAC;EAEb,MAAMW,UAAU,GAAG,MAAAA,CAAA,KAAY;IAC3B,IAAI;MAIA,MAAM;QAAEF,IAAI;QAAEG;MAAM,CAAC,GAAG,MAAMhB,QAAQ,CACjCiB,IAAI,CAAC,eAAe,CAAC,CACrBC,MAAM,CAAC,uBAAuB,CAAC,CAC/BC,EAAE,CAAC,SAAS,EAAE,KAAK,CAAC;MAEzB,IAAIH,KAAK,EAAE;QACPI,OAAO,CAACJ,KAAK,CAAC,oCAAoC,EAAEA,KAAK,CAAC;QAC1D;MACJ;MAEA,MAAMK,WAAW,GAAGlB,QAAQ,IAAIC,OAAO,EAAEkB,IAAI,IAAI,SAAS;MAE1D,MAAMC,KAAK,GAAGV,IAAI,CAACW,MAAM,CAACC,CAAC,IAAI;QAG3B,MAAMC,WAAW,GAAGD,CAAC,CAACE,OAAO,IAAIC,MAAM,CAACH,CAAC,CAACE,OAAO,CAAC,KAAKC,MAAM,CAACrB,aAAa,CAAC;QAG5E,MAAMsB,QAAQ,GAAGJ,CAAC,CAACI,QAAQ,IAAI,EAAE;QACjC,MAAMC,eAAe,GAAGC,KAAK,CAACC,OAAO,CAACH,QAAQ,CAAC,GACzCA,QAAQ,CAACI,GAAG,CAACC,CAAC,IAAIA,CAAC,CAACC,WAAW,CAAC,CAAC,CAAC,CAACC,QAAQ,CAACf,WAAW,CAACc,WAAW,CAAC,CAAC,CAAC,GACtEE,IAAI,CAACC,SAAS,CAACT,QAAQ,CAAC,CAACM,WAAW,CAAC,CAAC,CAACC,QAAQ,CAACf,WAAW,CAACc,WAAW,CAAC,CAAC,CAAC;QAEhF,OAAOT,WAAW,IAAII,eAAe;MACzC,CAAC,CAAC,CAACS,MAAM;MAETjC,oBAAoB,CAACiB,KAAK,CAAC;IAC/B,CAAC,CAAC,OAAOiB,GAAG,EAAE;MACVpB,OAAO,CAACJ,KAAK,CAACwB,GAAG,CAAC;IACtB;EACJ,CAAC;EAED1C,SAAS,CAAC,MAAM;IACZ,IAAI,CAACS,aAAa,EAAE;IAEpBQ,UAAU,CAAC,CAAC;IAIZ,MAAM0B,OAAO,GAAGzC,QAAQ,CACnByC,OAAO,CAAC,sBAAsB,CAAC,CAC/BC,EAAE,CACC,kBAAkB,EAClB;MACIC,KAAK,EAAE,GAAG;MACVC,MAAM,EAAE,QAAQ;MAChBC,KAAK,EAAE;IACX,CAAC,EACD,MAAM;MACF9B,UAAU,CAAC,CAAC;IAChB,CACJ,CAAC,CACA+B,SAAS,CAAC,CAAC;IAEhB,OAAO,MAAM;MACT9C,QAAQ,CAAC+C,aAAa,CAACN,OAAO,CAAC;IACnC,CAAC;EACL,CAAC,EAAE,CAAClC,aAAa,EAAEJ,QAAQ,EAAEC,OAAO,EAAEkB,IAAI,CAAC,CAAC;EAE5C,OAAOjB,iBAAiB;AAC5B","ignoreList":[]},"metadata":{"hasCjsExports":false},"sourceType":"module","externalDependencies":[]}