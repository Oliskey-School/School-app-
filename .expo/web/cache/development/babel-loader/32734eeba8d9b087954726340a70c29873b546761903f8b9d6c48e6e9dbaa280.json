{"ast":null,"code":"import { useState, useEffect } from 'react';\nimport { supabase } from '../lib/supabase';\nimport { useProfile } from '../context/ProfileContext';\nimport { getFormattedClassName } from '../constants';\nexport const useTeacherClasses = teacherId => {\n  const {\n    profile\n  } = useProfile();\n  const [classes, setClasses] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  useEffect(() => {\n    const fetchClasses = async () => {\n      let resolvedTeacherId = null;\n      if (teacherId) {\n        resolvedTeacherId = teacherId;\n      } else if (profile?.email) {\n        try {\n          const {\n            data: teacherData,\n            error: teacherError\n          } = await supabase.from('teachers').select('id').eq('email', profile.email).single();\n          if (teacherData) {\n            resolvedTeacherId = teacherData.id;\n          } else if (teacherError) {\n            console.error('Error fetching teacher profile by email:', teacherError);\n          }\n        } catch (err) {\n          console.error('Error in teacher lookup:', err);\n        }\n      }\n      if (!resolvedTeacherId) {\n        setLoading(false);\n        return;\n      }\n      setLoading(true);\n      try {\n        const {\n          data: assignments,\n          error: assignmentError\n        } = await supabase.from('teacher_classes').select('class_name, id').eq('teacher_id', resolvedTeacherId);\n        if (assignmentError) throw assignmentError;\n        const assignedClassNames = assignments?.map(a => a.class_name) || [];\n        const {\n          data: classesData,\n          error: classesError\n        } = await supabase.from('classes').select('*').order('grade', {\n          ascending: true\n        }).order('section', {\n          ascending: true\n        });\n        if (classesError) throw classesError;\n        const parseAssignment = name => {\n          const nameWithoutPrefix = name.replace(/^Grade\\s+/i, '');\n          const parts = nameWithoutPrefix.split(/\\s*[-–]\\s*/);\n          const cleanClass = parts[0].trim();\n          const assignedSubject = parts.length > 1 ? parts[1].trim() : null;\n          const match = cleanClass.match(/^(\\d+)([A-Za-z])?$/);\n          let result = {\n            type: 'string',\n            raw: name.toLowerCase(),\n            subject: assignedSubject,\n            grade: 0,\n            section: null\n          };\n          if (match) {\n            result.type = 'numeric';\n            result.grade = parseInt(match[1]);\n            result.section = match[2] || null;\n          }\n          return result;\n        };\n        const parsedAssignments = assignedClassNames.map(parseAssignment);\n        const finalClasses = [];\n        const addedKeys = new Set();\n        (classesData || []).forEach(c => {\n          if (!c.section || c.section.trim() === '') return;\n          const fname = getFormattedClassName(c.grade, c.section);\n          const key = `${c.grade}-${c.section}`;\n          if (addedKeys.has(key)) return;\n          const fnameLower = fname.toLowerCase();\n          const matchedAssignment = parsedAssignments.find(assignment => {\n            if (assignment.type === 'numeric') {\n              if (assignment.grade === c.grade) {\n                if (assignment.section) {\n                  return assignment.section.toLowerCase() === c.section.toLowerCase();\n                }\n                return true;\n              }\n              return false;\n            } else {\n              return assignment.raw.includes(fnameLower) || fnameLower.includes(assignment.raw) || assignment.raw.includes(`grade ${c.grade}`) || assignment.raw.includes(`${c.grade}${c.section.toLowerCase()}`);\n            }\n          });\n          if (matchedAssignment) {\n            finalClasses.push({\n              id: c.id,\n              grade: c.grade,\n              section: c.section,\n              subject: matchedAssignment.subject || c.subject || 'General',\n              studentCount: 0\n            });\n            addedKeys.add(key);\n          }\n        });\n        setClasses(finalClasses.sort((a, b) => {\n          if (a.grade !== b.grade) return a.grade - b.grade;\n          return a.section.localeCompare(b.section);\n        }));\n      } catch (err) {\n        console.error('Error fetching teacher classes:', err);\n        setError(err);\n      } finally {\n        setLoading(false);\n      }\n    };\n    fetchClasses();\n  }, [profile?.email, teacherId]);\n  return {\n    classes,\n    loading,\n    error\n  };\n};","map":{"version":3,"names":["useState","useEffect","supabase","useProfile","getFormattedClassName","useTeacherClasses","teacherId","profile","classes","setClasses","loading","setLoading","error","setError","fetchClasses","resolvedTeacherId","email","data","teacherData","teacherError","from","select","eq","single","id","console","err","assignments","assignmentError","assignedClassNames","map","a","class_name","classesData","classesError","order","ascending","parseAssignment","name","nameWithoutPrefix","replace","parts","split","cleanClass","trim","assignedSubject","length","match","result","type","raw","toLowerCase","subject","grade","section","parseInt","parsedAssignments","finalClasses","addedKeys","Set","forEach","c","fname","key","has","fnameLower","matchedAssignment","find","assignment","includes","push","studentCount","add","sort","b","localeCompare"],"sources":["C:/Users/USER/OneDrive/Desktop/Project/school-app-/hooks/useTeacherClasses.ts"],"sourcesContent":["import { useState, useEffect } from 'react';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useProfile } from '../context/ProfileContext';\r\nimport { getFormattedClassName } from '../constants';\r\n\r\nexport interface ClassInfo {\r\n    id: string;\r\n    grade: number;\r\n    section: string;\r\n    subject: string;\r\n    studentCount?: number;\r\n}\r\n\r\nexport const useTeacherClasses = (teacherId?: number | null) => {\r\n    const { profile } = useProfile();\r\n    const [classes, setClasses] = useState<ClassInfo[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [error, setError] = useState<any>(null);\r\n\r\n    useEffect(() => {\r\n        const fetchClasses = async () => {\r\n            let resolvedTeacherId: number | null = null;\r\n\r\n            // 1. Determine Teacher ID\r\n            if (teacherId) {\r\n                resolvedTeacherId = teacherId;\r\n            } else if (profile?.email) {\r\n                // Try fetching by email if no ID provided\r\n                try {\r\n                    const { data: teacherData, error: teacherError } = await supabase\r\n                        .from('teachers')\r\n                        .select('id')\r\n                        .eq('email', profile.email)\r\n                        .single();\r\n\r\n                    if (teacherData) {\r\n                        resolvedTeacherId = teacherData.id;\r\n                    } else if (teacherError) {\r\n                        console.error('Error fetching teacher profile by email:', teacherError);\r\n                    }\r\n                } catch (err) {\r\n                    console.error('Error in teacher lookup:', err);\r\n                }\r\n            }\r\n\r\n            if (!resolvedTeacherId) {\r\n                setLoading(false);\r\n                return;\r\n            }\r\n\r\n            setLoading(true);\r\n            try {\r\n                // 2. Fetch Assignments using the resolved ID\r\n                const { data: assignments, error: assignmentError } = await supabase\r\n                    .from('teacher_classes')\r\n                    .select('class_name, id')\r\n                    .eq('teacher_id', resolvedTeacherId);\r\n\r\n                if (assignmentError) throw assignmentError;\r\n                const assignedClassNames = assignments?.map(a => a.class_name) || [];\r\n\r\n                // 3. Fetch ALL classes\r\n                const { data: classesData, error: classesError } = await supabase\r\n                    .from('classes')\r\n                    .select('*')\r\n                    .order('grade', { ascending: true })\r\n                    .order('section', { ascending: true });\r\n\r\n                if (classesError) throw classesError;\r\n\r\n                // 4. Robust Matching & Parsing Logic\r\n                const parseAssignment = (name: string) => {\r\n                    // E.g. \"Grade 10 - Mathematics\" -> \"10\", \"Mathematics\"\r\n                    const nameWithoutPrefix = name.replace(/^Grade\\s+/i, '');\r\n                    const parts = nameWithoutPrefix.split(/\\s*[-–]\\s*/);\r\n\r\n                    const cleanClass = parts[0].trim();\r\n                    const assignedSubject = parts.length > 1 ? parts[1].trim() : null;\r\n\r\n                    const match = cleanClass.match(/^(\\d+)([A-Za-z])?$/);\r\n                    let result = {\r\n                        type: 'string',\r\n                        raw: name.toLowerCase(),\r\n                        subject: assignedSubject,\r\n                        grade: 0,\r\n                        section: null as string | null\r\n                    };\r\n\r\n                    if (match) {\r\n                        result.type = 'numeric';\r\n                        result.grade = parseInt(match[1]);\r\n                        result.section = match[2] || null;\r\n                    }\r\n                    return result;\r\n                };\r\n\r\n                const parsedAssignments = assignedClassNames.map(parseAssignment);\r\n                const finalClasses: ClassInfo[] = [];\r\n                const addedKeys = new Set<string>();\r\n\r\n                (classesData || []).forEach((c: any) => {\r\n                    // STRICT FILTER: Skip if section is missing or empty\r\n                    if (!c.section || c.section.trim() === '') return;\r\n\r\n                    const fname = getFormattedClassName(c.grade, c.section);\r\n                    const key = `${c.grade}-${c.section}`;\r\n\r\n                    // DEDUPLICATION: Skip if already added\r\n                    if (addedKeys.has(key)) return;\r\n\r\n                    const fnameLower = fname.toLowerCase();\r\n\r\n                    const matchedAssignment = parsedAssignments.find(assignment => {\r\n                        if (assignment.type === 'numeric') {\r\n                            if (assignment.grade === c.grade) {\r\n                                if (assignment.section) {\r\n                                    return assignment.section.toLowerCase() === c.section.toLowerCase();\r\n                                }\r\n                                return true;\r\n                            }\r\n                            return false;\r\n                        } else {\r\n                            // Fuzzy matching\r\n                            return assignment.raw.includes(fnameLower) ||\r\n                                fnameLower.includes(assignment.raw) ||\r\n                                assignment.raw.includes(`grade ${c.grade}`) ||\r\n                                assignment.raw.includes(`${c.grade}${c.section.toLowerCase()}`);\r\n                        }\r\n                    });\r\n\r\n                    if (matchedAssignment) {\r\n                        finalClasses.push({\r\n                            id: c.id,\r\n                            grade: c.grade,\r\n                            section: c.section,\r\n                            // Override subject if avail from assignment\r\n                            subject: matchedAssignment.subject || c.subject || 'General',\r\n                            studentCount: 0\r\n                        });\r\n                        addedKeys.add(key);\r\n                    }\r\n                });\r\n\r\n                // Sort\r\n                setClasses(finalClasses.sort((a, b) => {\r\n                    if (a.grade !== b.grade) return a.grade - b.grade;\r\n                    return a.section.localeCompare(b.section);\r\n                }));\r\n\r\n            } catch (err) {\r\n                console.error('Error fetching teacher classes:', err);\r\n                setError(err);\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n\r\n        fetchClasses();\r\n    }, [profile?.email, teacherId]);\r\n\r\n    return { classes, loading, error };\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{"hasCjsExports":false},"sourceType":"module","externalDependencies":[]}